<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Choice Seven Star ¬∑ Khata</title>
    <!-- html2canvas for bill download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- JSZip for backup/restore -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --primary-bg: #f5f8ff;
            --secondary-bg: #ffffff;
            --primary-brand: #0a1a3f;
            --text-dark: #121f3d;
            --text-light: #5a6b8c;
            --accent-blue: #4a6dff;
            --border-color: #e8eef8;
            --danger: #d93025;
            --success: #1e8e3e;
            --top-bar-height: 60px;
            --bottom-nav-height: 70px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            background: var(--primary-bg);
            color: var(--text-dark);
        }

        /* --- SPLASH SCREEN --- */
        .splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--primary-brand);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000; transition: opacity 0.5s ease-in-out; color: white;
        }
        .splash-logo {
            font-size: 2.5rem; font-weight: 800; letter-spacing: 1px;
            background: linear-gradient(145deg, #ffffff, #b5cbff);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .splash-sub { font-size: 1rem; opacity: 0.8; margin-top: 10px; }
        .splash-fade-out { opacity: 0; pointer-events: none; }

        /* --- APP SHELL --- */
        .app-shell {
            display: none;
            height: 100%;
            flex-direction: column;
        }

        /* TOP BAR */
        .top-bar {
            height: var(--top-bar-height);
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            padding: 0 20px;
            font-size: 1.4rem;
            font-weight: 700;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            position: relative;
            z-index: 10;
        }

        /* MAIN CONTENT AREA */
        .pages-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 24px 16px;
            padding-bottom: calc(var(--bottom-nav-height) + 24px);
        }
        .page { display: none; }
        .page.active-page { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* BOTTOM NAVIGATION */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--bottom-nav-height);
            background: var(--secondary-bg);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -4px 20px -10px rgba(0,20,60,0.1);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
        }
        .nav-btn {
            background: none; border: none;
            display: flex; flex-direction: column; align-items: center;
            gap: 4px; color: var(--text-light); font-weight: 600;
            font-size: 0.75rem; transition: color 0.2s;
        }
        .nav-btn i { font-size: 1.6rem; font-style: normal; }
        .nav-btn.active { color: var(--primary-brand); }
        .nav-btn-add {
            background: var(--primary-brand);
            color: white;
            width: 56px; height: 56px;
            border-radius: 50%;
            font-size: 2.2rem;
            display: flex; align-items: center; justify-content: center;
            transform: translateY(-20px);
            box-shadow: 0 6px 15px -4px rgba(10,26,63,0.5);
            border: 4px solid var(--secondary-bg);
        }

        /* --- UI COMPONENTS --- */
        .stat-card {
            background: var(--secondary-bg);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 6px 15px -8px rgba(0,30,70,0.1);
            margin-bottom: 16px;
        }
        .stat-label { font-size: 0.9rem; color: var(--text-light); font-weight: 500; }
        .stat-number { font-size: 2rem; font-weight: 700; color: var(--text-dark); margin-top: 8px; }

        .client-card {
            background: var(--secondary-bg);
            border-radius: 18px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 12px -8px rgba(0,20,60,0.1);
        }
        .client-info .name { font-size: 1.1rem; font-weight: 600; }
        .client-info .phone { font-size: 0.9rem; color: var(--text-light); margin-top: 2px; }
        .client-pending { background: #ffe8d9; color: #a14500; font-weight: 700; padding: 6px 12px; border-radius: 30px; font-size: 0.8rem; }
        
        .section-title { font-size: 1.3rem; margin-bottom: 16px; font-weight: 700; }
        
        .search-bar {
            width: 100%;
            background: var(--secondary-bg);
            border-radius: 30px;
            padding: 14px 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px -6px #001758;
            font-size: 1rem;
            margin-bottom: 24px;
        }
        .search-bar:focus { outline: 1px solid var(--primary-brand); }

        .btn {
            border: none;
            padding: 16px 20px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            text-align: center;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary-brand); color: white; }
        .btn-secondary { background: var(--border-color); color: var(--text-dark); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-icon { display: flex; align-items: center; justify-content: center; gap: 8px; }

        /* --- FULL SCREEN PAGE VIEWS --- */
        .page-view {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--primary-bg);
            z-index: 200;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .page-view.active { transform: translateX(0); }
        .page-view .top-bar {
            background: var(--secondary-bg);
            justify-content: space-between;
        }
        .page-view .top-bar .back-btn { font-size: 1.5rem; background: none; border: none; }
        .page-view-content {
            flex-grow: 1;
            padding: 24px 16px;
            overflow-y: auto;
        }
        .input-group { margin-bottom: 16px; }
        .input-group label { display: block; font-weight: 500; margin-bottom: 8px; color: var(--text-light); font-size: 0.9rem; padding-left: 10px; }
        .input-field {
            width: 100%;
            padding: 16px 20px;
            border: 1px solid var(--border-color);
            border-radius: 14px;
            font-size: 1rem;
            background: var(--secondary-bg);
        }
        .input-field:focus { outline: 1px solid var(--primary-brand); }
        .page-view-actions {
            padding: 16px;
            background: var(--secondary-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
        }

        /* --- BILL PAGE STYLING --- */
        .bill-capture-area {
            background: var(--secondary-bg);
            border-radius: 20px;
            padding: 16px;
            border: 2px solid var(--primary-brand);
            margin-bottom: 24px;
        }
        .bill-header { text-align: center; border-bottom: 2px solid var(--primary-brand); padding-bottom: 12px; margin-bottom: 16px; }
        .bill-shop-name { font-size: 1.6rem; font-weight: 800; color: var(--primary-brand); }
        .bill-sub-name { font-size: 0.9rem; color: var(--text-light); }
        .bill-info { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 16px; color: var(--text-light); }
        .bill-client-details { font-weight: 600; font-size: 1.1rem; margin-bottom: 20px; }
        .bill-items-table { width: 100%; border-collapse: collapse; }
        .bill-items-table th { text-align: left; font-size: 0.8rem; color: var(--text-light); padding-bottom: 8px; }
        .bill-item-row { border-bottom: 1px solid var(--border-color); }
        .bill-item-row td { padding: 12px 2px; }
        .bill-item-row input {
            width: 100%; border: 1px solid var(--border-color);
            padding: 8px; border-radius: 8px; font-size: 1rem;
        }
        .remove-row-btn { background: #ffe3e3; border: none; color: var(--danger); font-weight: bold; width: 32px; height: 32px; border-radius: 50%; }
        .bill-summary { background: #eaf1ff; padding: 16px; border-radius: 14px; margin-top: 20px; }
        .summary-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 1rem; }
        .summary-row.total { font-weight: 700; font-size: 1.2rem; border-top: 1px solid #d0dfff; margin-top: 8px; padding-top: 8px; }
        
        /* TOAST NOTIFICATION */
        .toast {
            position: fixed;
            bottom: calc(var(--bottom-nav-height) + 20px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(10, 26, 63, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            box-shadow: 0 4px 15px -5px #000;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            z-index: 300;
            pointer-events: none;
        }
        .toast.show { opacity: 1; transform: translate(-50%, -10px); }
    </style>
</head>
<body>
    <!-- SPLASH SCREEN -->
    <div class="splash-screen" id="splash">
        <div class="splash-logo">CHOICE SEVEN STAR</div>
        <div class="splash-sub">INVOICE MANAGEMENT</div>
    </div>

    <!-- MAIN APP SHELL -->
    <div class="app-shell" id="appShell">
        <div class="top-bar" id="pageTitle">Dashboard</div>
        <div class="pages-container">
            <div class="page active-page" id="dashboard-page"></div>
            <div class="page" id="clients-page"></div>
        </div>
        <div class="bottom-nav">
            <button class="nav-btn active" data-page="dashboard"><i>üìä</i><span>Dashboard</span></button>
            <button class="nav-btn-add" id="addClientBtn"><span>+</span></button>
            <button class="nav-btn" data-page="clients"><i>üë•</i><span>Clients</span></button>
        </div>
    </div>
    
    <!-- PAGE VIEWS -->
    <div class="page-view" id="clientFormPage">
        <div class="top-bar"><button class="back-btn" data-close-page="clientFormPage">‚Üê</button><span id="clientFormTitle"></span><div style="width: 24px;"></div></div>
        <div class="page-view-content"><div class="input-group"><label for="clientName">Full Name</label><input type="text" id="clientName" class="input-field"></div><div class="input-group"><label for="clientPhone">Phone Number</label><input type="tel" id="clientPhone" class="input-field"></div><div class="input-group"><label for="clientAddress">Address</label><input type="text" id="clientAddress" class="input-field"></div></div>
        <div class="page-view-actions"><button class="btn btn-secondary" data-close-page="clientFormPage">Cancel</button><button class="btn btn-primary" id="saveClientBtn">Save Client</button></div>
    </div>
    <div class="page-view" id="clientProfilePage">
        <div class="top-bar"><button class="back-btn" data-close-page="clientProfilePage">‚Üê</button><span id="profileName"></span><div style="width: 24px;"></div></div>
        <div class="page-view-content" id="profileContent"></div>
        <div class="page-view-actions"><button class="btn btn-primary" id="generateBillBtn">Generate New Bill</button></div>
    </div>
    <div class="page-view" id="billPage">
        <div class="top-bar"><button class="back-btn" data-close-page="billPage">‚Üê</button><span id="billPageTitle">Create Bill</span><div style="width: 24px;"></div></div>
        <div class="page-view-content"><button class="btn btn-icon" id="downloadBillBtn" style="background-color: var(--success); color: white; margin-bottom: 20px;"><span>‚¨áÔ∏è</span> Download Bill Image</button><div id="billCaptureArea" class="bill-capture-area"><div class="bill-header"><div class="bill-shop-name">Choice Seven Star</div><div class="bill-sub-name">Khata & Bill</div></div><div class="bill-info"><span id="billIdDisplay"></span><span id="billDateDisplay"></span></div><div class="bill-client-details">Bill to: <span id="billClientName"></span></div><table class="bill-items-table"><thead><tr><th>Item</th><th>Price</th><th>Qty</th><th></th></tr></thead><tbody id="billItemsBody"></tbody></table><div style="text-align: center; margin-top: 16px;"><button id="addItemRowBtn" class="btn btn-secondary" style="width: auto; padding: 8px 24px;">+ Add Item</button></div><div class="bill-summary"><div class="summary-row"><span>Subtotal</span><span id="subtotalView"></span></div><div class="summary-row"><span>Paid</span><span id="paidView"></span></div><div class="summary-row total"><span>Remaining</span><span id="remainingView"></span></div></div></div><div class="input-group" style="margin-top: 24px;"><label for="paidAmount">Amount Paid (‚Ç®)</label><input type="number" id="paidAmount" class="input-field" value="0"></div></div>
        <div class="page-view-actions"><button class="btn btn-secondary" data-close-page="billPage">Cancel</button><button class="btn btn-primary" id="saveBillBtn">Save Bill</button></div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
    (function() {
        // ----- APP INITIALIZATION -----
        const splash = document.getElementById('splash');
        const appShell = document.getElementById('appShell');
        setTimeout(() => {
            splash.classList.add('splash-fade-out');
            setTimeout(() => {
                splash.style.display = 'none';
                appShell.style.display = 'flex';
                renderPage('dashboard');
            }, 500);
        }, 2000);

        // ----- STATE & DATA MANAGEMENT -----
        let data = { clients: [] };
        let currentClientId = null;
        let currentBillClientId = null;
        let editingBillId = null;
        let currentBillItems = [];
        
        function loadData() {
            const stored = localStorage.getItem('cssKhataApp');
            if (stored) { try { data = JSON.parse(stored); } catch (e) { console.error("Failed to parse data", e); data = { clients: [] }; } }
            if (!data.clients) data.clients = [];
        }
        function saveData() { localStorage.setItem('cssKhataApp', JSON.stringify(data)); }
        loadData();

        // ----- UTILS -----
        const formatPKR = (amount) => '‚Ç® ' + Math.round(amount).toLocaleString('en-IN');
        const showToast = (msg) => { const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); };
        const generateBillId = () => 'INV-' + Date.now().toString().slice(-6);

        // ----- DOM ELEMENTS & PAGE VIEW HANDLING -----
        const pageTitleEl = document.getElementById('pageTitle');
        function openPage(pageId) { document.getElementById(pageId)?.classList.add('active'); }
        function closePage(pageId) { document.getElementById(pageId)?.classList.remove('active'); }
        document.querySelectorAll('[data-close-page]').forEach(btn => {
            btn.addEventListener('click', () => closePage(btn.dataset.closePage));
        });

        // ----- NAVIGATION -----
        const navButtons = document.querySelectorAll('.nav-btn');
        const pageElements = document.querySelectorAll('.page');
        navButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const pageId = btn.dataset.page;
                renderPage(pageId);
                navButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });

        function renderPage(pageId) {
            pageElements.forEach(p => p.classList.remove('active-page'));
            const targetPage = document.getElementById(`${pageId}-page`);
            if (targetPage) {
                if (pageId === 'dashboard') targetPage.innerHTML = renderDashboard();
                else if (pageId === 'clients') targetPage.innerHTML = renderClients();
                targetPage.classList.add('active-page');
            }
            pageTitleEl.innerText = pageId.charAt(0).toUpperCase() + pageId.slice(1);
        }

        // ----- PAGE CONTENT RENDERERS -----
        function renderDashboard() {
            let totalReceivable = data.clients.reduce((sum, c) => sum + (c.totalPending || 0), 0);
            const recentClients = data.clients.slice(-3).reverse();
            return `
                <div class="stat-card">
                    <div class="stat-label">Total Receivable</div>
                    <div class="stat-number">${formatPKR(totalReceivable)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Clients</div>
                    <div class="stat-number">${data.clients.length}</div>
                </div>

                <div class="stat-card" style="margin-top: 32px;">
                    <h2 class="section-title" style="margin-bottom:20px;">Data Management</h2>
                    <div style="display:flex; gap: 12px; flex-direction: column;">
                        <button class="btn btn-secondary btn-icon" id="backupBtn"><span>üíæ</span> Download Backup</button>
                        <button class="btn btn-secondary btn-icon" onclick="document.getElementById('restoreInput').click();"><span>üì§</span> Restore from Backup</button>
                        <input type="file" id="restoreInput" accept=".zip" style="display:none;" onchange="handleRestore(event)">
                    </div>
                </div>

                <h2 class="section-title" style="margin-top: 32px;">Recent Clients</h2>
                <div id="recentClientsList">
                    ${recentClients.length > 0 ? recentClients.map(c => `
                        <div class="client-card" data-view-profile="${c.id}">
                            <div class="client-info">
                                <div class="name">${c.name}</div>
                                <div class="phone">${c.phone}</div>
                            </div>
                            <div class="client-pending">${formatPKR(c.totalPending || 0)}</div>
                        </div>
                    `).join('') : '<p style="color: var(--text-light); text-align:center;">No clients yet. Add one!</p>'}
                </div>
            `;
        }

        // FIXED FUNCTION
        function renderClients() {
            let clientListHtml = data.clients.slice().reverse().map(c => `
                <div class="client-card" data-view-profile="${c.id}">
                    <div class="client-info">
                        <div class="name">${c.name}</div>
                        <div class="phone">${c.phone}</div>
                    </div>
                    <div class="client-pending">${formatPKR(c.totalPending || 0)}</div>
                </div>
            `).join('');

            if (data.clients.length === 0) {
                clientListHtml = '<p style="text-align:center; color: var(--text-light); padding: 20px;">No clients yet. Use the \'+\' button to add your first client!</p>';
            }

            return `
                <input class="search-bar" placeholder="Search by name or phone..." id="clientSearch" onkeyup="window.searchClients()">
                <div id="clientListContainer">
                    ${clientListHtml}
                </div>
            `;
        }
        
        window.searchClients = function() {
            const term = document.getElementById('clientSearch')?.value.toLowerCase() || '';
            const filtered = data.clients.filter(c => c.name.toLowerCase().includes(term) || c.phone.includes(term));
            const container = document.getElementById('clientListContainer');
            if(container) {
                let filteredHtml = filtered.slice().reverse().map(c => `<div class="client-card" data-view-profile="${c.id}"><div class="client-info"><div class="name">${c.name}</div><div class="phone">${c.phone}</div></div><div class="client-pending">${formatPKR(c.totalPending || 0)}</div></div>`).join('');
                if(filtered.length === 0) {
                    filteredHtml = '<p style="text-align:center; color: var(--text-light); padding: 20px;">No clients match your search.</p>';
                }
                container.innerHTML = filteredHtml;
            }
        };
        
        function showClientProfile(clientId) {
            const client = data.clients.find(c => c.id == clientId);
            if (!client) return;
            currentClientId = clientId;
            document.getElementById('profileName').innerText = client.name;
            const profileContent = document.getElementById('profileContent');
            const billsHtml = (client.bills || []).slice().reverse().map(b => `<div class="client-card" data-editbill='${JSON.stringify({billId: b.billId, clientId: client.id})}'>
                    <div class="client-info">
                        <div class="name">${b.billId} <span style="font-weight:400; font-size:0.8em; color: var(--text-light)">(${b.date})</span></div>
                        <div>Total: ${formatPKR(b.totalAmount)} | Paid: ${formatPKR(b.paidAmount)}</div>
                    </div><span style="font-size: 1.5rem;">‚Ä∫</span></div>`).join('') || '<p style="text-align:center; color: var(--text-light); padding: 20px;">No bills recorded.</p>';
            profileContent.innerHTML = `<div style="background: var(--secondary-bg); padding: 20px; border-radius: 16px; margin-bottom: 24px;"><p><strong>Phone:</strong> ${client.phone}</p><p><strong>Address:</strong> ${client.address || 'N/A'}</p><hr style="border:none; border-top:1px solid var(--border-color); margin: 16px 0;"><div style="display:flex; justify-content:space-between; align-items:center;"><span style="font-weight:600;">Total Pending:</span><span class="client-pending" style="font-size:1rem;">${formatPKR(client.totalPending || 0)}</span></div></div><div style="display:flex; gap:12px; margin-bottom: 24px;"><button class="btn btn-secondary" data-edit-client="${client.id}">Edit Client</button><button class="btn btn-danger" data-delete-client="${client.id}">Delete Client</button></div><h2 class="section-title">Bill History</h2><div id="billHistory">${billsHtml}</div>`;
            openPage('clientProfilePage');
        }

        const addClientBtn = document.getElementById('addClientBtn');
        const clientFormTitle = document.getElementById('clientFormTitle');
        const clientNameInp = document.getElementById('clientName');
        const clientPhoneInp = document.getElementById('clientPhone');
        const clientAddressInp = document.getElementById('clientAddress');
        const saveClientBtn = document.getElementById('saveClientBtn');

        function openClientFormForAdd() {
            currentClientId = null;
            clientFormTitle.innerText = 'Add New Client';
            clientNameInp.value = ''; clientPhoneInp.value = ''; clientAddressInp.value = '';
            openPage('clientFormPage');
        }
        function openClientFormForEdit(clientId) {
            const client = data.clients.find(c => c.id == clientId);
            if (!client) return;
            currentClientId = clientId;
            clientFormTitle.innerText = 'Edit Client';
            clientNameInp.value = client.name; clientPhoneInp.value = client.phone; clientAddressInp.value = client.address || '';
            openPage('clientFormPage');
        }
        addClientBtn.addEventListener('click', openClientFormForAdd);
        saveClientBtn.addEventListener('click', () => {
            const name = clientNameInp.value.trim(); const phone = clientPhoneInp.value.trim();
            if (!name) { alert('Client name is required.'); return; }
            if (currentClientId) {
                const client = data.clients.find(c => c.id == currentClientId);
                if (client) { client.name = name; client.phone = phone; client.address = clientAddressInp.value; }
            } else {
                data.clients.push({ id: 'c' + Date.now(), name, phone, address: clientAddressInp.value, totalPending: 0, bills: [] });
            }
            saveData(); showToast('Client saved!'); closePage('clientFormPage');
            renderPage('clients');
            if (currentClientId) showClientProfile(currentClientId);
        });
        
        const billItemsBody = document.getElementById('billItemsBody');
        const addItemRowBtn = document.getElementById('addItemRowBtn');
        const paidAmountInp = document.getElementById('paidAmount');
        const subtotalSpan = document.getElementById('subtotalView');
        const remainingSpan = document.getElementById('remainingView');
        const paidViewSpan = document.getElementById('paidView');
        const billClientNameSpan = document.getElementById('billClientName');
        const billIdDisplay = document.getElementById('billIdDisplay');
        const billDateDisplay = document.getElementById('billDateDisplay');
        const downloadBillBtn = document.getElementById('downloadBillBtn');
        const saveBillBtn = document.getElementById('saveBillBtn');
        
        function openBillForm(clientId, bill = null) {
            currentBillClientId = clientId;
            const client = data.clients.find(c => c.id == clientId);
            if (!client) return;
            billClientNameSpan.innerText = client.name;
            if (bill) {
                editingBillId = bill.billId; currentBillItems = bill.items.map(i => ({...i})); paidAmountInp.value = bill.paidAmount; billIdDisplay.innerText = bill.billId; billDateDisplay.innerText = bill.date || new Date().toISOString().slice(0, 10);
            } else {
                editingBillId = null; currentBillItems = [{ name: '', price: 0, qty: 1 }]; paidAmountInp.value = 0; billIdDisplay.innerText = generateBillId(); billDateDisplay.innerText = new Date().toISOString().slice(0, 10);
            }
            renderBillItems(); openPage('billPage');
        }
        function renderBillItems() {
            billItemsBody.innerHTML = currentBillItems.map((item, idx) => `
                <tr class="bill-item-row">
                    <td><input value="${(item.name || '').replace(/"/g, '&quot;')}" placeholder="Item" data-index="${idx}" data-field="name"></td>
                    <td><input type="number" value="${item.price || 0}" data-index="${idx}" data-field="price" style="width: 80px;"></td>
                    <td><input type="number" value="${item.qty || 1}" data-index="${idx}" data-field="qty" style="width: 60px;"></td>
                    <td><button class="remove-row-btn" data-index="${idx}">√ó</button></td>
                </tr>`).join('');
            calculateBillTotals();
        }
        function calculateBillTotals() {
            let subtotal = currentBillItems.reduce((sum, item) => sum + (item.price || 0) * (item.qty || 1), 0);
            subtotalSpan.innerText = formatPKR(subtotal);
            const paid = parseFloat(paidAmountInp.value) || 0;
            paidViewSpan.innerText = formatPKR(paid);
            remainingSpan.innerText = formatPKR(Math.max(0, subtotal - paid));
        }
        addItemRowBtn.addEventListener('click', () => { currentBillItems.push({ name: '', price: 0, qty: 1 }); renderBillItems(); });
        billItemsBody.addEventListener('input', e => { if (e.target.dataset.index) { const { index, field } = e.target.dataset; currentBillItems[index][field] = e.target.type === 'number' ? parseFloat(e.target.value) || 0 : e.target.value; calculateBillTotals(); } });
        billItemsBody.addEventListener('click', e => { if (e.target.classList.contains('remove-row-btn')) { currentBillItems.splice(e.target.dataset.index, 1); renderBillItems(); } });
        paidAmountInp.addEventListener('input', calculateBillTotals);
        saveBillBtn.addEventListener('click', () => {
            const client = data.clients.find(c => c.id == currentBillClientId); if (!client) return;
            const totalAmount = currentBillItems.reduce((sum, i) => sum + (i.price || 0) * (i.qty || 1), 0);
            const paidAmount = parseFloat(paidAmountInp.value) || 0;
            const newBill = { billId: billIdDisplay.innerText, date: billDateDisplay.innerText, items: currentBillItems.filter(i => i.name && i.name.trim()), totalAmount, paidAmount, remainingAmount: totalAmount - paidAmount };
            if (editingBillId) { const billIndex = (client.bills || []).findIndex(b => b.billId == editingBillId); if (billIndex > -1) client.bills[billIndex] = newBill; } 
            else { if (!client.bills) client.bills = []; client.bills.push(newBill); }
            client.totalPending = (client.bills || []).reduce((sum, b) => sum + (b.totalAmount - b.paidAmount), 0);
            saveData(); showToast('Bill saved!'); closePage('billPage'); showClientProfile(client.id);
        });
        downloadBillBtn.addEventListener('click', () => {
            const area = document.getElementById('billCaptureArea'); const btn = document.getElementById('downloadBillBtn'); const originalText = btn.innerHTML;
            btn.innerHTML = '<span>‚è≥</span> Processing...'; btn.disabled = true;
            const clone = area.cloneNode(true); clone.querySelector('#addItemRowBtn').style.display = 'none'; clone.querySelectorAll('.remove-row-btn').forEach(b => b.style.display = 'none');
            clone.style.width = '400px'; document.body.appendChild(clone);
            html2canvas(clone, { scale: 2, backgroundColor: '#ffffff', useCORS: true })
            .then(canvas => { const link = document.createElement('a'); link.download = `bill-${billIdDisplay.innerText}.png`; link.href = canvas.toDataURL('image/png'); link.click(); showToast('Bill image downloaded!'); })
            .catch(err => { showToast('Error capturing image.'); console.error(err); })
            .finally(() => { document.body.removeChild(clone); btn.innerHTML = originalText; btn.disabled = false; });
        });
        
        // --- BACKUP & RESTORE FUNCTIONS ---
        function handleBackup() {
            showToast("Generating backup...");
            const dataString = localStorage.getItem('cssKhataApp');
            if (!dataString || JSON.parse(dataString).clients.length === 0) {
                showToast("No data to back up.");
                return;
            }
            const zip = new JSZip();
            zip.file("backup.json", dataString);
            const readmeContent = `Choice Seven Star Khata App Backup\nDate: ${new Date().toLocaleString()}\n\nDO NOT EDIT THE backup.json FILE MANUALLY.`;
            zip.file("readme.txt", readmeContent);
            zip.generateAsync({ type: "blob" })
                .then(function(content) {
                    const link = document.createElement('a');
                    const date = new Date().toISOString().slice(0,10);
                    link.download = `css-khata-backup-${date}.zip`;
                    link.href = URL.createObjectURL(content);
                    link.click();
                    URL.revokeObjectURL(link.href);
                    showToast("Backup downloaded!");
                })
                .catch(err => { showToast("Error creating backup."); console.error("Backup error:", err); });
        }
        window.handleRestore = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!file.name.endsWith('.zip')) {
                showToast("Invalid file type. Please select a .zip backup file.");
                event.target.value = ''; return;
            }
            if (!confirm("Are you sure you want to restore? This will ERASE all current data and replace it with the backup data.")) {
                event.target.value = ''; return;
            }
            showToast("Restoring data...");
            const zip = new JSZip();
            zip.loadAsync(file)
                .then(zipContent => {
                    const backupFile = zipContent.file("backup.json");
                    if (!backupFile) throw new Error("Invalid backup file: backup.json not found.");
                    return backupFile.async("string");
                })
                .then(jsonString => {
                    try {
                        JSON.parse(jsonString); 
                        localStorage.setItem('cssKhataApp', jsonString);
                        showToast("Restore successful! App will now reload.");
                        setTimeout(() => location.reload(), 1500);
                    } catch (e) {
                        throw new Error("Backup file is corrupted or not valid JSON.");
                    }
                })
                .catch(err => { showToast(`Restore failed: ${err.message}`); console.error("Restore error:", err); })
                .finally(() => { event.target.value = ''; });
        }
        
        // GLOBAL EVENT LISTENER
        document.addEventListener('click', (e) => {
            const viewProfileTarget = e.target.closest('[data-view-profile]');
            if (viewProfileTarget) { showClientProfile(viewProfileTarget.dataset.viewProfile); return; }
            const editClientTarget = e.target.closest('[data-edit-client]');
            if (editClientTarget) { openClientFormForEdit(editClientTarget.dataset.editClient); return; }
            const deleteClientTarget = e.target.closest('[data-delete-client]');
            if (deleteClientTarget) { const clientId = deleteClientTarget.dataset.deleteClient; if (confirm('Are you sure you want to delete this client and all their bills? This action cannot be undone.')) { data.clients = data.clients.filter(c => c.id !== clientId); saveData(); showToast('Client deleted'); closePage('clientProfilePage'); renderPage('clients'); } return; }
            const editBillTarget = e.target.closest('[data-editbill]');
            if (editBillTarget) { const { billId, clientId } = JSON.parse(editBillTarget.dataset.editbill); const client = data.clients.find(c => c.id == clientId); const bill = client?.bills?.find(b => b.billId == billId); if (bill) openBillForm(clientId, bill); return; }
            const generateBillTarget = document.getElementById('generateBillBtn');
            if (e.target === generateBillTarget) { openBillForm(currentClientId); }
            const backupBtn = e.target.closest('#backupBtn');
            if(backupBtn) { handleBackup(); }
        });
    })();
    </script>
</body>
</html>
